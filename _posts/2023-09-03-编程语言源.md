---
layout: post
title:  "编程语言源"
date:   2023-09-02 23:00:02 +0800
categories: 生态
tag: 兼容性
---


# 编程语言源

## 概述

本文探索不同编程语言都是如何管理其依赖包的，如何做到快速安装使用？如何为其构建的源做贡献？以及，如果想自定义一个第三方包管理，怎么做？

## python

### 自定义包上传官方源

自定义包上传到pypi的教程：[Packaging Python Projects — Python Packaging User Guide](https://packaging.python.org/en/latest/tutorials/packaging-projects/)



有两点需要注意：

1、需要设置2FA验证后才能生成token。

什么是2FA验证：类似一种动态口令，需要手机扫二维码，获得口令码，再输入验证。

腾讯小程序有一个比较好用的： Authentic

2、如果遇到上传失败，提示403的情况，检查包名是否跟其他人重复：

```bash
ERROR    HTTPError: 403 Forbidden from https://test.pypi.org/legacy/               
         The user 'wutengda' isn't allowed to upload to project                    
         'example-package-testing'. See https://test.pypi.org/help/#project-name   
         for more information. 
```



上传成功后，就可以使用该命令安装：

```bash
(venv) wutengda@wutengda:~/packaging_tutorial$ pip install example-package-wutengda
 
Collecting example-package-wutengda
  Downloading example_package_wutengda-0.0.1-py3-none-any.whl (2.7 kB)
Installing collected packages: example-package-wutengda
Successfully installed example-package-wutengda-0.0.1
```



场景思考：

对于pytorch，在arm上直接使用报没有和cuda联合编译，导致运行失败的情况。此时我们手动编译构建了一个可用的联合编译版本，如何提交到pypi？

方式1：理想的，推动pytorch社区合入发布联合编译版本

方式2：在pypi上开一个新账号，提交新包到该账号下。该方式弊端是，你没法用pytorch命名，而使用者想用的话，只能去适配你的名称

方式3：新建一个私有pypi，将联合编译版本提交到这里。该方式需考虑：

- 是否允许采用pytorch命名？
- 当联合编译版本依赖其他包时，是否允许跨仓库关联解决？



### 自定义私有源

参考：[Setting up a Private PyPI Server | TestDriven.io](https://testdriven.io/blog/private-pypi/)

安装pypiserver

```bash
pip install pypiserver
cd <dir-for-host-pypi>
pypi-server run -a . -P .
```

拉起成功后，可登录：localhost:8080

`-a . -P .`表示不需要登录就可以上传包，只要在上传时保持账号密码为空即可。

在没有指定目录时，上传的包会自动放到$HOME/packages目录下，如果该目录没有提前创建，上传会失败。

上传成功后，即可访问http://localhost:8080/simple查看已上传的包。



如果A包在自定义的仓库，B包在官方pypi源，此时pip install的行为是什么样的？示例：

```bash
# requirements.txt
example-package-wutengda==0.0.1  # 在官方pypi源
use-example-priv==0.0.1  # 在本地localhost:8080/simple私有源
```

安装前清理cache：

```bash
pip cache purge
```

此时执行：

```bash
(venv) wutengda@wutengda:~/test$ pip install --index-url http://localhost:8080 --trusted-host=localhost:8080 -r requirements.txt
Looking in indexes: http://localhost:8080
Collecting example-package-wutengda==0.0.1
  Downloading example_package_wutengda-0.0.1-py3-none-any.whl (2.7 kB)
DEPRECATION: The HTML index page being used (http://localhost:8080/simple/use-example-priv/) is not a proper HTML 5 document. This is in violation of PEP 503 which requires these pages to be well-formed HTML 5 documents. Please reach out to the owners of this index page, and ask them to update this index page to a valid HTML 5 document. pip 22.2 will enforce this behaviour change. Discussion can be found at https://github.com/pypa/pip/issues/10825
Collecting use-example-priv==0.0.1
  Downloading http://localhost:8080/packages/use_example_priv-0.0.1-py3-none-any.whl (2.7 kB)
Installing collected packages: use-example-priv, example-package-wutengda
Successfully installed example-package-wutengda-0.0.1 use-example-priv-0.0.1
```

可以正常安装， 不过会有一个DEPRECATION。

结论：私有pypi源内如果有包依赖到官方源，则pip能够处理这种关系。



## java

TODO

## go

TODO

## js

TODO

## rust

TODO

## ruby

TODO

